from: https://www.bilibili.com/video/BV1Sw411d7r1



## P1.kong网关特性和架构分析

kong采用插件机制进行功能定制，插件集（可以是0或n个）在api请求响应循环的生命周期中被执行。插件使用Lua编写，目前已有几个基础功能：http基本认证，密钥认证，CORS(Cross-Origin Resource Sharing, 跨域资源共享)，tcp，udp, 文件日志、api请求限流，请求转发以及ngin监控。

## P2.基于centos7安装kong

官网：www.konghq.com/install

### 安装PostgreSQL

强烈建议安装 PostgreSQL9.6

https://www.postgresql.org/donwload/linux/redhat/

```sh
# Install the repository RPM:
sudo yum install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm

# Install PostgreSQL:
sudo yum install -y postgresql96-server

# Optionally initialize the database and enable automatic start:
sudo /usr/pgsql-9.6/bin/postgresql96-setup initdb
sudo systemctl enable postgresql-9.6
sudo systemctl start postgresql-9.6

# 查看状态
systemctl status postgresql-9.6
```

![image-20211122143747696](https://gitee.com/jstone001/booknote/raw/master/jpgBed/image-20211122143747696.png)

### 配置postgresql

```sh
# 创建一个Linux用户 'kong'
adduser kong

# 切换到Linux系统用户 `postgres`, 因为它是PostgreSql，数据库系统员
su postgres

# 进入PostgreSQL 控制台
psql

# 设置用户postgres的密码【仅首次需要】
# 注意开头的\ 必须有
\password postgres

# 创建一个PostgreSQL用户`kong`, 和上面创建的Linux用户`kong`对应
# 密码'123456'根据自己需要生成
create user kong with password '123456'
# 创建一个PostgreSQL数据库`kong`
CREATE DATABASE kong owner kong
# 将数据库`kong`授权给PostgreSQL 用户 `kong`
grant all privileges on database kong to kong

# 退出 postgreSQL 控制台
\q
```

### postgresSQL 4种身份认证方式

- trust: 凡是连接到服务器的，都可信任。只需要提供postgreSQL用户名，可以没有对应的操作系统同名用户。

- password和md5: 对于远程访问，需要提供postgreSQL用户名和密码。对于本地连接，提供postgreSQL用户名密码之外，还需要有操作系统访问权（用操作系统同名用户验证）。Password和md5的区别，就是远程英语考几分传输的密码是否用md5加密。
- ident: 对于远程访问，从ident服务器获得客户端操作系统用户名，然后把操作系统作为数据库用户名进行登录对于本地连接，实际上使用了peer。
- peer: 对于本地访问，通过客户端操作系统内核来获取当前系统登录的用户名，并作为postgreSQL用户名进行登录。



1. 修改/var/lib/pgsql/9.6/data/pg_hba.conf文件，注释掉所有默认配置，并添加一条host all all 0.0.0.0/0 trust 默认，无论远程还是本地访问，任何postgreSQL用户和数据库，都使用trust认证方式。
2. 修改vim  /var/lib/pgsql/9.6/data/postgresql.conf 
```sh
listen_addresses ='*'
```
3. 修改这2个配置后，重启之后，才可以远程链接


```sh
systemctl restart postgresql-9.6  # 重启数据库
```

### 安装kong

CentOS7 下

https://download.konghq.com/gateway-1.x-centos-7/Packages/k/

安装命令

```sh
wget https://download.konghq.com/gateway-1.x-centos-7/Packages/k/kong-1.5.1.e17.amd64.rpm
sudo yum install kong-1.5.1.e17.amd64.rpm
```

### 配置kong

kong的默认配置文件是/etc/kong/kong.conf.default, 使用cp /etc/kong/kong.conf.default /etc/kong/kong.conf 命令，复制一份新的配置文件。

配置kong.conf

```sh
database = postgres

pg_host=127.0.0.1
pg_port=5432
pg_user=kong
pg_password=123456
pg_database=kong

pg_ssl=off
```

```sh
kong migrations bootstrap -c /etc/kong/kong.conf  # 初始化数据库
```

```sh
kong start -c /etc/kong/kong.conf	# 启动命令
Kong stop
kong reload  # 重新加载
```

默认情况下，Kong绑定4个端口

- Proxy 8000: 接收客户端的http 请求，并转发到后端的upstream。
- Proxy 8443: 接收客户端的https 请求，并转发到后端的upstream。
- Admin 8001：接收管理员的http请求，进行kong管理。
- Admin 8444：接收管理员的https请求，进行kong管理。

```sh
# 请求proxy 端口
curl http://127.0.0.1:8000
{"message":"no Route matched with those values"}	# 因为我们没有配置kong路由。

# 请求admin端口
curl http://127.0.0.1:8001
{"plugins":{"enabled_in_cluster":["jwt-auth","cors"],"available_on_server":....   # 省略
```



## P3.基于docker搭建kong&konga

2种方式DB-less，with a Database

### docker安装 Kong

```sh
docker network create kong-net	# 构建kong的容器网络
# 搭建数据库环境
```

### 搭建数据库环境

Cassandra容器：

```sh
docker run -d --name kong-database \
		--network=kong-net \
		-p 9042:9042 \
		cassandra:3 
```

PostgreSQL:

```sh
docker run -d --name kong-database \
		--network=kong-net
		-p 5432:5432 \
		-e "POSTGRES_USER=kong" \
		-e "POSTGRES_DB=kong"  \
		postgres:9.6
```

这里有个小问题，如果你使用PostgreSQL，想挂载卷持久化数据到宿主机。通过-v命令是不好用的。这里推荐使用docker volumn create来创建一个挂载。

```sh
docker volume create kong-volume
```

然后上面的PostgreSQL就可以通过-v kong-volume:/var/lib/postgresql/data 进行挂载了。

```sh
docker run -d --name kong-database \
  --network=kong-net \
  -p 5432:5432 \
  -v kong-volume:/var/lib/postgresql/data \
  -e "POSTGRES_USER=kong" \
  -e "POSTGRES_DB=kong" \
  -e "POSTGRES_PASSWORD=kong" \
  postgres:9.6
```

### 初始化或者迁移数据库



## P4.kong动态负载均衡配置
## P5.kong基于Basic Auth&JWT身份认证
## P6.kong限流配置
## P7.黑白名单的配置